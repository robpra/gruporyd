/* ============================================================
   SIGNALR CLIENT â€“ VoiceAPI Provisioning + Hooks
   ============================================================ */

console.log("âš¡ Cargando SignalR Client...");

let conn = null;
let instanceId = Date.now() + "-" + Math.floor(Math.random() * 999999);

async function StartSignalR() {
    try {
        console.log("---- Inicializando SignalR ----");
        console.log("Instance ID generado:", instanceId);

        conn = new signalR.HubConnectionBuilder()
            .withUrl("/gruporyd/eventsHub?instanceId=" + instanceId)
            .configureLogging(signalR.LogLevel.Information)
            .build();

        conn.onclose(() => {
            console.error("âŒ ConexiÃ³n perdida. Reintentando...");
            setTimeout(StartSignalR, 3000);
        });

        /* ============================================================
           RECEPCIÃ“N DE PROVISIONING
        ============================================================ */
        conn.on("provision", async (payload) => {
            console.log("ğŸ“¦ Provisioning recibido:", payload);

            // Guardar datos globales
            window.idAgente  = payload.idAgente;
            window.idUsuario = payload.idUsuario;
            window.idQueue   = payload.servicio;

            window.SipUsername = payload.usuario;
            window.SipPassword = payload.token;
            window.sipDomain   = payload.sipDomain;
            window.wssPort     = payload.wss;

            window.ProvisioningData = payload;

            // ğŸ”¥ Unirse al grupo correcto de agente
            const group = "AGENTE_" + payload.idAgente;
            console.log("ğŸ‘‰ Suscribiendo al grupo:", group);

            try {
                await conn.invoke("JoinGroup", group);
                console.log("ğŸŸ¢ JoinGroup OK");
            } catch (e) {
                console.error("âŒ Error al unirse al grupo:", e);
            }

            // ğŸ”„ Crear UserAgent SIP
            if (window.RecreateUserAgent) {
                console.log("ğŸ”„ Ejecutando RecreateUserAgent()");
                window.RecreateUserAgent();
            } else {
                console.error("âŒ RecreateUserAgent() no estÃ¡ definido");
            }
        });

        /* ============================================================
           HOOK EVENTS
        ============================================================ */
        conn.on("HookEvent", (eventData) => {
            console.log("ğŸ“ HookEvent recibido:", eventData);
            if (window.HandleHookEvent) {
                window.HandleHookEvent(eventData);
            }
        });

        /* ============================================================
           Conectar al Hub
        ============================================================ */
        await conn.start();
        console.log("ğŸŸ¢ SignalR conectado:", conn.connectionId);

        // ğŸ”¥ SIEMPRE unirse al grupo prelogin
        await conn.invoke("JoinGroup", "prelogin");
        console.log("ğŸŸ¢ JoinGroup prelogin OK");

    } catch (err) {
        console.error("âŒ Error en SignalR:", err);
        setTimeout(StartSignalR, 3000);
    }
}

window.StartSignalR = StartSignalR;

