/* ============================================================
   SIGNALR CLIENT – FIX V1 (sin doble conexión)
   ============================================================ */

console.log("? Cargando SignalR Client...");

let conn = null;
let instanceId = Date.now() + "-" + Math.floor(Math.random() * 999999);

async function StartSignalR() {
    console.log("---- Inicializando SignalR ----");
    console.log("Instance ID generado:", instanceId);

    conn = new signalR.HubConnectionBuilder()
        .withUrl("/gruporyd/eventsHub?instanceId=" + instanceId)
        .withAutomaticReconnect()   // ?? Reconexión nativa
        .configureLogging(signalR.LogLevel.Information)
        .build();

    /* ============================================================
       RECEPCIÓN DE PROVISIONING
    ============================================================ */
    conn.on("provision", async (payload) => {
        console.log("?? Provisioning recibido:", payload);

        // Datos globales
        window.idAgente = payload.idAgente;
        window.idUsuario = payload.idUsuario;

        window.idQueue = payload.servicio;
        window.prioridad = "2";   // FIX

        window.SipUsername = payload.usuario;
        window.sipDomain  = payload.host;
        window.wssPort = payload.wss;

        window.ProvisioningData = payload;

        // ?? Unirse al grupo correcto de AGENTE
        const group = "AGENTE_" + payload.idAgente;
        console.log("?? Suscribiendo al grupo:", group);

        try {
            await conn.invoke("JoinGroup", group);
            console.log("?? JoinGroup OK");
        } catch (e) {
            console.error("? Error al unirse al grupo:", e);
        }

        // ?? Crear UserAgent SIP
        if (window.RecreateUserAgent) {
            console.log("?? Ejecutando RecreateUserAgent()");
            window.RecreateUserAgent(payload);
        } else {
            console.error("? RecreateUserAgent() no está definido");
        }
    });

    /* ============================================================
       HOOK EVENTS
    ============================================================ */
    conn.on("HookEvent", (eventData) => {
        console.log("?? HookEvent recibido:", eventData);
        if (window.HandleHookEvent) {
            window.HandleHookEvent(eventData);
        }
    });

    /* ============================================================
       Conectar al Hub
    ============================================================ */
    try {
        await conn.start();
        console.log("?? SignalR conectado:", conn.connectionId);

        // ?? Solo 1 vez ? unirse a prelogin
        await conn.invoke("JoinGroup", "prelogin");
        console.log("?? JoinGroup prelogin OK");

    } catch (err) {
        console.error("? Error al conectar SignalR:", err);
    }
}

window.StartSignalR = StartSignalR;
