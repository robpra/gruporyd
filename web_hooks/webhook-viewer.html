<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Webhook Log Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .badge{font-size:.70rem;padding:.15rem .45rem;border-radius:.5rem}
    .ev-ring{background:#fef3c7} .ev-ans{background:#dcfce7} .ev-term{background:#fee2e2}
    pre{white-space:pre-wrap;word-break:break-word}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto p-4 space-y-4">
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
      <div>
        <h1 class="text-2xl font-bold">Webhook Log Viewer</h1>
        <p class="text-sm text-gray-600">Ver eventos recientes desde DB o log.</p>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <label class="text-sm">Modo:</label>
        <select id="mode" class="border rounded px-2 py-1">
          <option value="live">En vivo (API)</option>
          <option value="paste">Pegar texto</option>
        </select>
        <label class="text-sm">Autorefresh</label>
        <input id="auto" type="checkbox" class="h-4 w-4" checked />
        <label class="text-sm">cada</label>
        <input id="secs" type="number" value="5" min="2" class="w-16 border rounded px-2 py-1" />
        <button id="refresh" class="px-3 py-1 rounded bg-gray-900 text-white">Actualizar</button>
      </div>
    </header>

    <section id="pasteBox" class="hidden">
      <textarea id="paste" rows="6" class="w-full border rounded p-2" placeholder="[2025-10-11T23:49:41+00:00] {json}"></textarea>
      <div class="mt-2 flex gap-2">
        <button id="parse" class="px-3 py-1 rounded bg-blue-600 text-white">Formatear</button>
        <span class="text-xs text-gray-500">Pega líneas tipo: <code>[fecha] {"event":"call.ringing",...}</code></span>
      </div>
    </section>

    <section class="bg-white rounded-xl shadow p-3">
      <div class="flex items-center justify-between">
        <div class="flex gap-2 items-center">
          <span class="badge bg-yellow-200">ringing</span>
          <span class="badge bg-green-200">answered</span>
          <span class="badge bg-red-200">terminated</span>
        </div>
        <div class="text-sm text-gray-500"><span id="meta"></span></div>
      </div>
      <div id="list" class="mt-3 grid grid-cols-1 gap-2"></div>
    </section>
  </div>

<script>
const API = "hooks-events.php";
let timer = null, lastId = 0;

function clsFor(ev){
  if (ev === "call.ringing") return "ev-ring";
  if (ev === "call.answered") return "ev-ans";
  if (ev === "call.terminated") return "ev-term";
  return "";
}
function fmt(obj){ return JSON.stringify(obj, null, 2); }

function render(items, append=false){
  const list = document.getElementById("list");
  if (!append) list.innerHTML = "";
  items.forEach(it => {
    const card = document.createElement("div");
    card.className = `border rounded-lg p-3 ${clsFor(it.event)}`;
    card.innerHTML = `
      <div class="flex flex-wrap items-center justify-between gap-2">
        <div class="font-mono text-sm"><b>${it.event}</b> <span class="text-gray-500">#${it.id}</span></div>
        <div class="text-xs text-gray-600">${it.ts_db || ""}</div>
      </div>
      <div class="text-xs text-gray-700 mt-1">
        <span class="badge bg-gray-200">dir: ${it.direction ?? "-"}</span>
        <span class="badge bg-gray-200">from: ${it.from_user ?? "-"}</span>
        <span class="badge bg-gray-200">to: ${it.to_user ?? "-"}</span>
      </div>
      <details class="mt-2">
        <summary class="cursor-pointer text-sm text-gray-800">Ver JSON</summary>
        <pre class="mt-2 bg-gray-50 border rounded p-2 text-xs">${fmt(it.raw)}</pre>
      </details>
    `;
    list.appendChild(card);
    if (it.id && it.id > lastId) lastId = it.id;
  });
}

async function fetchEvents(incremental=false){
  const params = new URLSearchParams();
  params.set("limit", incremental ? "200" : "200");
  if (incremental && lastId) params.set("since_id", String(lastId));
  const res = await fetch(`${API}?${params.toString()}`);
  if (!res.ok) throw new Error("No se pudo leer hooks-events.php");
  const data = await res.json();
  document.getElementById("meta").textContent = `${data.source} • ${data.count} eventos`;
  const items = data.items || [];
  render(items, incremental);
}

function startAuto(){
  stopAuto();
  if (!document.getElementById("auto").checked) return;
  const secs = Math.max(2, parseInt(document.getElementById("secs").value || "5", 10));
  timer = setInterval(() => fetchEvents(true).catch(console.warn), secs*1000);
}
function stopAuto(){ if (timer) { clearInterval(timer); timer = null; } }

document.getElementById("refresh").addEventListener("click", () => {
  if (document.getElementById("mode").value === "live") {
    lastId = 0;
    fetchEvents(false).catch(alert);
    startAuto();
  } else {
    stopAuto();
  }
});
document.getElementById("mode").addEventListener("change", (e) => {
  const pasteMode = e.target.value === "paste";
  document.getElementById("pasteBox").classList.toggle("hidden", !pasteMode);
  if (!pasteMode) { lastId = 0; fetchEvents(false).catch(alert); startAuto(); }
  else { stopAuto(); }
});
document.getElementById("parse").addEventListener("click", () => {
  const txt = document.getElementById("paste").value.trim();
  const lines = txt.split(/\n+/).filter(Boolean);
  const items = [];
  let id = 0;
  for (const line of lines) {
    const m = line.match(/^\[(.*?)\]\s+(\{.*\})$/);
    if (!m) continue;
    try {
      const obj = JSON.parse(m[2]);
      items.push({
        id: ++id,
        ts_db: m[1],
        event: obj.event || "unknown",
        direction: obj.payload?.direction || null,
        from_user: obj.payload?.from?.uriUser || null,
        to_user: obj.payload?.to?.uriUser || null,
        raw: obj
      });
    } catch {}
  }
  render(items, false);
  document.getElementById("meta").textContent = `pegado • ${items.length} eventos`;
});

// inicial
fetchEvents(false).catch(console.warn);
startAuto();
</script>
</body>
</html>
